CREATE TABLE work.colt_start AS
SELECT
    CAST(
        regexp_replace(
            element_at(eventattributes, 'ess_process_timestamp'),
            'T|Z',
            ' '
        ) AS timestamp
    ) AS ess_process_timestamp_c,

    CAST(
        regexp_replace(
            element_at(eventattributes, 'ess_src_event_timestamp'),
            'T|Z',
            ' '
        ) AS timestamp
    ) AS ess_src_event_timestamp_c,

    CAST(
        regexp_replace(
            json_extract_scalar(
                element_at(eventattributes, 'SourceEventHeader'),
                '$.eventTimestamp'
            ),
            'T|Z',
            ' '
        ) AS timestamp
    ) AS eventTimestamp_c,

    json_extract_scalar(
        element_at(eventattributes, 'SourceEventHeader'),
        '$.eventActivityName'
    ) AS eventActivityName_c,

    json_extract_scalar(
        element_at(eventattributes, 'eventPayload'),
        '$.alertType'
    ) AS alertType_c,

    json_extract_scalar(
        element_at(eventattributes, 'eventPayload'),
        '$.clientId'
    ) AS clientId_c,

    json_extract_scalar(
        element_at(eventattributes, 'eventPayload'),
        '$.thresholdAmount'
    ) AS thresholdAmount_c,

    CAST(
        regexp_replace(
            json_extract_scalar(
                element_at(eventattributes, 'eventPayload'),
                '$.transactionTimestamp'
            ),
            'T|Z',
            ' '
        ) AS timestamp
    ) AS transactionTimestamp_c,

    json_extract_scalar(
        element_at(eventattributes, 'eventPayload'),
        '$.alertAmount'
    ) AS alertAmount_c,

    json_extract_scalar(
        element_at(eventattributes, 'eventPayload'),
        '$.previousBalance'
    ) AS previousBalance_c,

    json_extract_scalar(
        element_at(eventattributes, 'eventPayload'),
        '$.accountStatus'
    ) AS accountStatus_c,

    json_extract_scalar(
        element_at(eventattributes, 'eventPayload'),
        '$.accountId'
    ) AS accountId,

    json_extract_scalar(
        element_at(eventattributes, 'eventPayload'),
        '$.processingCentre'
    ) AS processingCentre_c,

    json_extract_scalar(
        element_at(eventattributes, 'eventPayload'),
        '$.accountCloseInd'
    ) AS accountCloseInd_c,

    json_extract_scalar(
        element_at(eventattributes, 'eventPayload'),
        '$.decisionId'
    ) AS decisionId,

    json_extract_scalar(
        element_at(eventattributes, 'eventPayload'),
        '$.reasonCodes'
    ) AS reasonCodes_c

FROM prod_brt0_ess.zgv0___colt_front_end_system

WHERE
    partition_date > DATE '&pardt'
    AND json_extract_scalar(
            element_at(eventattributes, 'eventPayload'),
            '$.alertType'
        ) = 'DDA_BALANCE_ALERT'
    AND json_extract_scalar(
            element_at(eventattributes, 'eventPayload'),
            '$.transactionTimestamp'
        ) BETWEEN '&snap_dt_hive' AND '&today';
