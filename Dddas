proc sql;
  connect to trino (
    server="strplvaexh0001.fg.rbc.com"
    port=8443
    catalog="hive"
    schema="prod_brt0_ess"
    user="&USER."
    password="&PASSWORD."
    ssl="true"
  );

  create table work.c86_colt as
  select * from connection to trino
  (

    WITH raw AS (
        SELECT
            eventattributes,
            partition_date
        FROM prod_brt0_ess.zgv0___colt_front_end_system
        WHERE partition_date BETWEEN DATE '%sysfunc(putn(&snap_dt_hive, yymmdd10.))'
                              AND DATE '%sysfunc(putn(&today, yymmdd10.))'
            AND CAST(element_at(eventattributes, 'eventPayload') AS varchar)
                LIKE '%DDA_BALANCE_ALERT%'
    ),

    base AS (
        SELECT
            try(json_parse(element_at(eventattributes, 'eventPayload'))) AS payload,
            try(json_parse(element_at(eventattributes, 'SourceEventHeader'))) AS hdr,
            
            try(CAST(from_iso8601_timestamp(
                element_at(eventattributes,'ess_process_timestamp')
            ) AS timestamp)) AS ess_process_timestamp_c,

            try(CAST(from_iso8601_timestamp(
                element_at(eventattributes,'ess_src_event_timestamp')
            ) AS timestamp)) AS ess_src_event_timestamp_c,

            partition_date
        FROM raw
    )

    SELECT
        ess_process_timestamp_c,
        ess_src_event_timestamp_c,

        try(
            CAST(
                from_iso8601_timestamp(
                    json_extract_scalar(hdr,'$.eventTimestamp')
                ) AS timestamp
            )
        ) AS eventtimestamp_c,

        json_extract_scalar(hdr,'$.eventActivityName') AS eventactivityname_c,

        json_extract_scalar(payload,'$.alertType') AS alerttype_c,
        json_extract_scalar(payload,'$.clientId') AS clientid_c,
        json_extract_scalar(payload,'$.accountId') AS accountid,

        try(CAST(json_extract_scalar(payload,'$.thresholdAmount') AS double)) AS thresholdamount_c,

        try(
            CAST(
                from_iso8601_timestamp(
                    json_extract_scalar(payload,'$.transactionTimestamp')
                ) AS timestamp
            )
        ) AS transactiontimestamp_c,

        try(CAST(json_extract_scalar(payload,'$.alertAmount') AS double)) AS alertamount_c,
        try(CAST(json_extract_scalar(payload,'$.previousBalance') AS double)) AS previousbalance_c,

        json_extract_scalar(payload,'$.accountStatus') AS accountstatus_c,
        json_extract_scalar(payload,'$.processingCentre') AS processingcentre_c,
        json_extract_scalar(payload,'$.accountCloseInd') AS accountcloseind_c,
        json_extract_scalar(payload,'$.decisionId') AS decisionid,
        json_extract_scalar(payload,'$.reasonCodes') AS reasoncodes_c

    FROM base

    WHERE json_extract_scalar(payload,'$.alertType') = 'DDA_BALANCE_ALERT'
      AND try(
            CAST(
                from_iso8601_timestamp(
                    json_extract_scalar(payload,'$.transactionTimestamp')
                ) AS timestamp
            )
          )
          BETWEEN TIMESTAMP '%sysfunc(putn(&snap_dt_hive, yymmdd10.)) 00:00:00'
              AND TIMESTAMP '%sysfunc(putn(&today, yymmdd10.)) 23:59:59'

  );

  disconnect from trino;
quit;
